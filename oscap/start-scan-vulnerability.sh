#!/bin/bash
#set -x

    NOM_SI="$1"
    nom_serveur="$2"
    REMOTE_URL8="https://security.almalinux.org/oval/org.almalinux.alsa-8.xml"
    REMOTE_URL9="https://security.almalinux.org/oval/org.almalinux.alsa-9.xml"
    LOCAL_FILE8="org.almalinux.alsa-8.xml"
    LOCAL_FILE9="org.almalinux.alsa-9.xml"
    RESULT_FILE="/opt/oscap/results/oscap-oval-results-${nom_serveur}.xml"

function show_help {
    echo "Usage: $0 <NOM_SI> <NOM_SERVEUR>"
    echo "  <NOM_SI>      : Nom du SI (obligatoire)"
    echo "  <NOM_SERVEUR> : Nom du serveur ou adresse IP (obligatoire)"
    echo "  Sans option ou avec une option invalide : Affiche cette aide"
}

function get_os_version {
    os_version=$(ssh root@"$1" "cat /etc/os-release | grep '^VERSION_ID' | cut -d'=' -f2 | cut -d'.' -f1" | tr -d '"')
    echo "$os_version"
}

function run_scan {
    NOM_SI="$1"
    nom_serveur="$2"

    if [[ "$nom_serveur" == "localhost" || "$nom_serveur" == "localhost.localdomain" ]]; then
	os_version=$(cat /etc/os-release | grep '^VERSION_ID' | cut -d'=' -f2 | cut -d'.' -f1 | tr -d '"')
    	if [ "$os_version" == "8" ]; then
		oscap oval eval --results /tmp/oscap-oval-results-"$nom_serveur".xml /opt/oscap/$LOCAL_FILE8
		mv /tmp/oscap-oval-results-"$nom_serveur".xml /opt/oscap/results/
	elif [ "$os_version" == "9" ]; then
		oscap oval eval --results /tmp/oscap-oval-results-"$nom_serveur".xml /opt/oscap/$LOCAL_FILE9
		mv /tmp/oscap-oval-results-"$nom_serveur".xml /opt/oscap/results/
	else
		echo "Aucune version AlmaLinux en local trouvée."
		exit
	fi
    else 
    	os_version=$(get_os_version "$nom_serveur")
    	if [ "$os_version" == "8" ]; then
       		scp $LOCAL_FILE8 root@"$nom_serveur":/tmp/
        	ssh root@"$nom_serveur" "oscap oval eval --results /tmp/oscap-oval-results-${nom_serveur}.xml /tmp/$LOCAL_FILE8"
        	scp root@"$nom_serveur":/tmp/oscap-oval-results-${nom_serveur}.xml /opt/oscap/results/
	elif [ "$os_version" == "9" ]; then
       		scp $LOCAL_FILE9 root@"$nom_serveur":/tmp/
        	ssh root@"$nom_serveur" "oscap oval eval --results /tmp/oscap-oval-results-${nom_serveur}.xml /tmp/$LOCAL_FILE9"
        	scp root@"$nom_serveur":/tmp/oscap-oval-results-${nom_serveur}.xml /opt/oscap/results/
    	else
        	echo "Version AlmaLinux  inconnue ${os_version} sur ${nom_serveur}."
        	exit 1
    	fi
    fi
}

if [ $# -lt 2 ]; then
    show_help
    exit 1
fi

REMOTE8=$(echo -e $REMOTE_URL8 | sed -E 's|https?://([^/]+).*|\1|')
echo "Test de connectivité avec le serveur $REMOTE8..."
if ping -c 1  $REMOTE8; then
    echo "Connectivité OK ave $REMOTE8. Téléchargement du fichier OVAL."
    wget "$REMOTE_URL8" -O $LOCAL_FILE8 && echo "Fichier OVAL téléchargé avec succès."
else
    echo "Pas de connectivité. Utilisation du fichier local si disponible."
    if [ -f "$LOCAL_FILE8" ]; then
	    echo "Fichier OVAL local trouvé : $LOCAL_FILE8"
    else 
	    echo "Aucun fichier OVAL trouvé, quit."
	    exit 1
    fi
fi

REMOTE9=$(echo -e $REMOTE_URL9 | sed -E 's|https?://([^/]+).*|\1|')
echo "Test de connectivité avec le serveur $REMOTE9..."
if ping -c 1  $REMOTE9; then
    echo "Connectivité OK ave $REMOTE9. Téléchargement du fichier OVAL."
    wget  "$REMOTE_URL9" -O $LOCAL_FILE9 && echo "Fichier OVAL téléchargé avec succès."
else
    echo "Pas de connectivité. Utilisation du fichier local si disponible."
    if [ -f "$LOCAL_FILE9" ]; then
	    echo "Fichier OVAL local trouvé : $LOCAL_FILE9"
    else 
	    echo "Aucun fichier OVAL trouvé, quit."
	    exit 1
    fi
fi


run_scan "$NOM_SI" "$nom_serveur"
python3 /opt/oscap/insert-into-database-vuln.py "$NOM_SI" "$nom_serveur" "$RESULT_FILE"
